#!/bin/sh
timestamp() {
  local line

  while read -r line; do
    printf "[%s] %s\n" "$(date)" "$line"
  done
}

{
  echo "Removing containers"

  for filter in "name=builder-init-*" "name=builder-cloner-*" "label=com.codeclimate.role=builder" "name=cc-engines-*"; do
    printf "Removing containers with %s\n" "$filter"
    docker ps -a -f "$filter" | awk '/day|week|month/ { print $1 }' \
      | xargs --max-args 500 --max-procs 0 --no-run-if-empty docker rm
  done
} | timestamp
